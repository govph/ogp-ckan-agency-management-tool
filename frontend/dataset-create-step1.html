{% extends 'frontend/index.html' %}
{% block title %}Create Dataset | Manager Tool{% endblock %}
{% block content %}
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 fuelux">
        <form method="POST" id="new-dataset-form">
            <div class="fuelux">
                <div class="wizard">
                    <ul class="steps">
                        <li data-target="#step1" class="active">
                            <span class="badge badge-info">1</span>Dataset Info<span class="chevron"></span>
                        </li>
                        <li data-target="#step2">
                            <span class="badge">2</span>Additional Info<span class="chevron"></span>
                        </li>
                        <li data-target="#step3">
                            <span class="badge">3</span>Add Resource<span class="chevron"></span>
                        </li>
                    </ul>
                    <div class="actions">
                        <button type="button" class="btn btn-sm btn-primary btn-prev" disabled>
                            <i class="fa fa-arrow-left"></i>Prev
                        </button>
                        <button type="submit" class="btn btn-sm btn-success btn-next" data-last="Finish"> Next<i class="fa fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <div class="step-pane active form-horizontal" id="step1">
                        <div class="form-group">
                            <label for="dataset-title" class="col-sm-2 control-label"><span class="text-danger">*</span> Title</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control step1" name="indexed_dataset_title" id="dataset-title" placeholder="A descriptive title" value="{% if dataset %}{{ dataset.dataset_title }}{% endif %}" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"><span class="text-danger">*</span> Description</label>
                            <div class="col-sm-9">
                                <textarea class="form-control step1" name="unindexed_dataset_description" id="dataset-description" placeholder="Some useful notes about the data" rows="4" required>{% if dataset %}{{ dataset.dataset_description }}{% endif %}</textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"><span class="text-danger">*</span> Categories</label>
                            <div class="col-sm-9">
                                <select class="form-control step1" name="indexed_dataset_category" id="dataset-category" required>
                                    <option value="">Select a Category</option>
                                    <option value="Agriculture" {% if dataset and dataset.dataset_category == "Agriculture" %}selected{% endif %}>Agriculture</option>
                                    <option value="Cultural" {% if dataset and dataset.dataset_category == "Cultural" %}selected{% endif %}>Cultural</option>
                                    <option value="Earth Observation" {% if dataset and dataset.dataset_category == "Earth Observation" %}selected{% endif %}>Earth Observation</option>
                                    <option value="Economy" {% if dataset and dataset.dataset_category == "Economy" %}selected{% endif %}>Economy</option>
                                    <option value="Education" {% if dataset and dataset.dataset_category == "Education" %}selected{% endif %}>Education</option>
                                    <option value="Energy" {% if dataset and dataset.dataset_category == "Energy" %}selected{% endif %}>Energy</option>
                                    <option value="Environment" {% if dataset and dataset.dataset_category == "Environment" %}selected{% endif %}>Environment</option>
                                    <option value="Employment" {% if dataset and dataset.dataset_category == "Employment" %}selected{% endif %}>Employment</option>
                                    <option value="Geospatial" {% if dataset and dataset.dataset_category == "Geospatial" %}selected{% endif %}>Geospatial</option>
                                    <option value="Health" {% if dataset and dataset.dataset_category == "Health" %}selected{% endif %}>Health</option>
                                    <option value="Infrastructure" {% if dataset and dataset.dataset_category == "Infrastructure" %}selected{% endif %}>Infrastructure</option>
                                    <option value="Law and Justice" {% if dataset and dataset.dataset_category == "Law and Justice" %}selected{% endif %}>Law and Justice</option>
                                    <option value="Local Government" {% if dataset and dataset.dataset_category == "Local Government" %}selected{% endif %}>Local Government</option>
                                    <option value="Politics" {% if dataset and dataset.dataset_category == "Politics" %}selected{% endif %}>Politics</option>
                                    <option value="Population" {% if dataset and dataset.dataset_category == "Population" %}selected{% endif %}>Population</option>
                                    <option value="Public Administration" {% if dataset and dataset.dataset_category == "Public Administration" %}selected{% endif %}>Public Administration</option>
                                    <option value="Public Finance" {% if dataset and dataset.dataset_category == "Public Finance" %}selected{% endif %}>Public Finance</option>
                                    <option value="Science and Research" {% if dataset and dataset.dataset_category == "Science and Research" %}selected{% endif %}>Science and Research</option>
                                    <option value="Social Welfare" {% if dataset and dataset.dataset_category == "Social Welfare" %}selected{% endif %}>Social Welfare</option>
                                    <option value="Transport and Communication" {% if dataset and dataset.dataset_category == "Transport and Communication" %}selected{% endif %}>Transport and Communication</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label">License</label>
                            <div class="col-sm-9">
                                <select class="form-control step1" name="indexed_license_id" id="dataset-license-id" required>
                                    <option value="notspecified" {% if dataset and dataset.license_id == "notspecified" %}selected{% endif %}>License not specified</option>
                                    <option value="cc-by" {% if dataset and dataset.license_id == "cc-by" %}selected{% endif %}>Creative Commons Attribution</option>
                                    <option value="cc-by-sa" {% if dataset and dataset.license_id == "cc-by-sa" %}selected{% endif %}>Creative Commons Attribution Share-Alike</option>
                                    <option value="cc-zero" {% if dataset and dataset.license_id == "cc-zero" %}selected{% endif %}>Creative Commons CCZero</option>
                                    <option value="cc-nc" {% if dataset and dataset.license_id == "cc-nc" %}selected{% endif %}>Creative Commons Non-Commercial (Any)</option>
                                    <option value="gfdl" {% if dataset and dataset.license_id == "gfdl" %}selected{% endif %}>GNU Free Documentation License</option>
                                    <option value="odc-by" {% if dataset and dataset.license_id == "odc-by" %}selected{% endif %}>Open Data Commons Attribution License</option>
                                    <option value="odc-odbl" {% if dataset and dataset.license_id == "odc-odbl" %}selected{% endif %}>Open Data Commons Open Database License (ODbL)</option>
                                    <option value="odc-pddl" {% if dataset and dataset.license_id == "odc-pddl" %}selected{% endif %}>Open Data Commons Public Domain Dedication and License (PDDL)</option>
                                    <option value="other-at" {% if dataset and dataset.license_id == "other-at" %}selected{% endif %}>Other (Attribution)</option>
                                    <option value="other-nc" {% if dataset and dataset.license_id == "other-nc" %}selected{% endif %}>Other (Non-Commercial)</option>
                                    <option value="other-closed" {% if dataset and dataset.license_id == "other-closed" %}selected{% endif %}>Other (Not Open)</option>
                                    <option value="other-open" {% if dataset and dataset.license_id == "other-open" %}selected{% endif %}>Other (Open)</option>
                                    <option value="other-pd" {% if dataset and dataset.license_id == "other-pd" %}selected{% endif %}>Other (Public Domain)</option>
                                    <option value="uk-ogl" {% if dataset and dataset.license_id == "uk-ogl" %}selected{% endif %}>UK Open Government Licence (OGL)</option>
                                </select>
                            </div>
                        </div>

                        {% if user.role == "OPENDATAADMIN" %}
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"><span class="text-danger">*</span> Department</label>
                            <div class="col-sm-9">
                                <select class="form-control step1" name="indexed_department" id="dataset-department" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"><span class="text-danger">*</span> Agency</label>
                            <div class="col-sm-9">
                                <select class="form-control step1" name="agency" id="agency" required>
                                    {% if dataset and dataset.agency %}
                                    <option value="{{dataset.agency}}">{{ dataset.agency }}</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"><span class="text-danger">*</span> Region</label>
                            <div class="col-sm-9">
                                <select class="form-control step1" name="region" id="region" required>
                                    {% if dataset and dataset.region %}
                                    <option value="{{dataset.region}}">{{ dataset.region }}</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"><span class="text-danger">*</span> Operating Unit</label>
                            <div class="col-sm-9">
                                <select class="form-control step1" name="operating_unit" id="operating-unit" required>
                                    {% if dataset and dataset.operating_unit %}
                                    <option value="{{dataset.operating_unit}}->{{ dataset.uacs }}">{{ dataset.operating_unit }}</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        {% else %}
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"><span class="text-danger">*</span> Department</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="dataset-department" name="indexed_department" value="{{ user.department|upper }}" readonly>
                            </div>
                        </div>
                        {% endif %}
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label">Open Data Initiative (ODI) Certificate</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="unindexed_odi_certificate" id="dataset-odi-certificate" placeholder="https://certificates.theodi.org/datasets/00000/certificate" value="{% if dataset %}{{ dataset.odi_certificate }}{% endif %}">
                                <p class="help-block">Create assessment and generate certificate for this dataset at <a href="https://certificates.theodi.org" target="_blank">ODI Certificate</a>.
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </form>
    </div>
{% endblock %}
{% block script %}
    <script>
        var department = "{% if dataset %}{{ dataset.department }}{% endif %}";
        $(document).ready(function (){
            $("#dataset-title").focus();
            loadUacsDepartment();
        });
        $("#new-dataset-form").submit(function (e){
            $("div.form-group").removeClass("has-error");
            $("p.help-block").remove();
            if($("#dataset-title").val().length <= 2){
                $("#dataset-title").closest("div.form-group").addClass("has-error");
                $("#dataset-title").after($("<p>", { class: "help-block", text: "Title must be at least 3 characters long." }));
                $("#dataset-title").focus();
                e.preventDefault();
                return
            }
            $(this).find(".form-control").prop("readonly", true);
            $(this).find("button:submit").prepend($("<i>", { class: "fa fa-fw fa-spin fa-circle-o-notch" }));
            $(this).find(".actions").children(".btn").prop("disabled", true);
        });
        $("#dataset-title").keyup(function (){
            if(this.value.length >= 3){
                $(this).next("p.help-block").remove();
                $(this).closest("div.form-group").removeClass("has-error");
            }
        });
        $("#dataset-department").change(function (){
            var this_obj = $(this);
            this_obj.prop("disabled", true);
            this_obj.after($("<span>", { class: "fa fa-fw fa-lg fa-spin fa-circle-o-notch form-control-feedback", "aria-hidden": true, style: "top: 20px;" }));
            $("#registerAccountForm").find("button:submit").prop("disabled", true);
            $("#agency, #region, #operating-unit").empty().prop("disabled", true);
            $.getJSON("/api/v1/uacs?department=" + this.value).done(function(d) {
                $("#agency").html($("<option>", { value: "", disabled: "", selected: "", text: "Select an Agency"}));
                for(i=0;i<d.data.length;i++){
                    $("#agency").append($("<option>", { value: d.data[i], text: d.data[i] }));
                }
                this_obj.prop("disabled", false);
                $("#agency").prop("disabled", false);
                this_obj.next("span.fa").remove();
            }).fail(function( jqxhr, textStatus, error ) {
                $("#dataset-department").empty().append($("<option>", { value: "", selected: "", text: "Cannot load agencies, try again", disabled: "" }));
                this_obj.prop("disabled", false);
                this_obj.next("span.fa").remove();
                $("#agency").prop("disabled", false);
            });
        });
        $("#agency").change(function (){
            var this_obj = $(this);
            this_obj.prop("disabled", true);
            this_obj.after($("<span>", { class: "fa fa-fw fa-lg fa-spin fa-circle-o-notch form-control-feedback", "aria-hidden": true, style: "top: 20px;" }));
            $("#registerAccountForm").find("button:submit").prop("disabled", true);
            $("#region, #operating-unit").empty().prop("disabled", true);
            $.getJSON("/api/v1/uacs?department=" + $("#dataset-department").val() + "&agency=" + this_obj.val()).done(function(d) {
                $("#region").html($("<option>", { value: "", disabled: "", selected: "", text: "SELECT A REGION"}));
                for(i=0;i<d.data.length;i++){
                    $("#region").append($("<option>", { value: d.data[i], text: d.data[i] }));
                }
                this_obj.prop("disabled", false);
                $("#region").prop("disabled", false);
                this_obj.next("span.fa").remove();
            }).fail(function( jqxhr, textStatus, error ) {
                $("#region").empty().append($("<option>", { value: "", selected: "", text: "Cannot load regions, try again", disabled: "" }));
                this_obj.prop("disabled", false);
                this_obj.next("span.fa").remove();
                $("#region").prop("disabled", false);
            });
        });
        $("#region").change(function (){
            var this_obj = $(this);
            this_obj.prop("disabled", true);
            this_obj.after($("<span>", { class: "fa fa-fw fa-lg fa-spin fa-circle-o-notch form-control-feedback", "aria-hidden": true, style: "top: 20px;" }));
            $("#registerAccountForm").find("button:submit").prop("disabled", true);
            $("#operating-unit").empty().prop("disabled", true);
            $.getJSON("/api/v1/uacs?department=" + $("#dataset-department").val() + "&agency=" + $("#agency").val() + "&region=" + this_obj.val()).done(function(d) {
                $("#operating-unit").html($("<option>", { value: "", disabled: "", selected: "", text: "SELECT AN OPERATING UNIT"}));
                for(key in d.data){
                    $("#operating-unit").append($("<option>", { value: key + "->" + d.data[key], text: key }));
                }
                this_obj.prop("disabled", false);
                $("#operating-unit").prop("disabled", false);
                this_obj.next("span.fa").remove();
            }).fail(function( jqxhr, textStatus, error ) {
                $("#operating-unit").empty().append($("<option>", { value: "", selected: "", text: "Cannot load regions, try again", disabled: "" }));
                this_obj.prop("disabled", false);
                this_obj.next("span.fa").remove();
                $("#operating-unit").prop("disabled", false);
            });
        });
        $("#operating-unit").change(function (){
            $("#registerAccountForm").find("button:submit").prop("disabled", false);
            $("#designation").focus();
        });
        function loadUacsDepartment(){
            $.getJSON("/api/v1/uacs").done(function(d) {
                $("#dataset-department").html($("<option>", { value: "", disabled: "", selected: "", text: "SELECT A DEPARTMENT"}));
                for(i=0;i<d.data.length;i++){
                    if(department == d.data[i]){
                        $("#dataset-department").append($("<option>", { value: d.data[i], text: d.data[i], selected: "" }));
                    }
                    else{
                        $("#dataset-department").append($("<option>", { value: d.data[i], text: d.data[i] }));
                    }
                }
                $("#dataset-department").prop("disabled", false);
            }).fail(function( jqxhr, textStatus, error ) {
                $("#dataset-department").empty().append($("<option>", { value: "", selected: "", text: "Cannot load departments, try again", disabled: "" }));
            });
        }
    </script>
{% endblock %}